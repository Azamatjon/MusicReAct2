<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<div class="page-inner" th:fragment="content">
    <div id="main-wrapper">
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-white">
                    <div class="panel-heading clearfix">
                        <h4 class="panel-title">Changing main data</h4>
                    </div>
                    <div class="panel-body">
                        <form id="change_data">
                            <div style="display: none;" class="alert alert-warning alert-dismissible fade in" id="confirmation" role="alert">
                                <button type="button" id="closeconfirm" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                                <h4></h4>
                                <p></p>
                                <p>
                                    <button type="button" id="reload" class="btn btn-default">Ok</button>
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="email">Email address</label>
                                <input type="email" th:value="${user.getEmail()}" name="email" class="form-control" id="email" placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label for="firstName">First name</label>
                                <input type="text" th:value="${user.getName()}" name="firstName" class="form-control" id="firstName" placeholder="Enter first name">
                            </div>
                            <div class="form-group">
                                <label for="LastName">Last name</label>
                                <input type="text" th:value="${user.getLastName()}" name="lastName" class="form-control" id="LastName" placeholder="Enter last name">
                            </div>
                            <div class="form-group">
                                <label for="avatar">Change an avatar</label>
                                <input type="file" name="avatar" accept="image/jpeg,image/png,image/gif" class="form-control" id="avatar" placeholder="Choose an avatar">
                                <br/>
                                <button type="button" id="deleteAvatar" class="btn btn-danger btn-addon m-b-xs btn-rounded btn-xs pull-right"><i class="fa fa-trash"></i> Delete Avatar</button>

                            </div>

                            <button type="submit" class="btn btn-primary" id="saveChanges">Save changes</button>
                            <!-- Button trigger modal -->
                            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteUserModal">Delete Account</button>
                            <!-- Modal -->
                            <div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                            <h4 class="modal-title" id="deleteUserModalLabel">Deleting User Account</h4>
                                        </div>
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <p>
                                                    You are about to delete your profile, if you want to continue enter your password.
                                                </p>
                                            </div>
                                            <div class="form-group">
                                                <label for="input-password" class="col-sm-2 control-label">Password</label>
                                                <div class="col-sm-10">
                                                    <input type="password" class="form-control" id="deleteUserPassword" placeholder="Password">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <br/>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" id="cancelDeleteAccount"class="btn btn-default" data-dismiss="modal">Cancel</button>
                                            <button type="button" id="confirmDeleteAccount" class="btn btn-danger">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="panel panel-white">
                    <div class="panel-heading clearfix">
                        <h4 class="panel-title">Changing a password</h4>
                    </div>
                    <div class="panel-body">
                        <form id="change_pass" class="form-horizontal">
                            <div class="form-group">
                                <label for="currentPassword" class="col-sm-2 control-label">Current password</label>
                                <div class="col-sm-10">
                                    <input type="password" name="oldPassword" class="form-control" id="currentPassword" placeholder="Current Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password" class="col-sm-2 control-label">New password</label>
                                <div class="col-sm-10">
                                    <input type="password" name="newPassword" class="form-control" id="password" placeholder="New Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password2" class="col-sm-2 control-label">Repeat a password</label>
                                <div class="col-sm-10">
                                    <input type="password" name="confirmationNewPassword" class="form-control" id="password2" placeholder="Confirm New Password">
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-offset-2 col-sm-10">
                                    <button type="submit" class="btn btn-success">Change password</button>
                                </div>
                            </div>
                        </form>



                    </div>
                </div>
            </div>
        </div><!-- Row -->
    </div><!-- Main Wrapper -->
    <copyright th:replace="admin/copyrightFooter:: content"></copyright>
</div>


<sc th:if="${cssSwitcher.isPermitted()}" th:fragment="endScript">
    <!-- Scripts are shown there-->
    <script src="/adm/assets/js/pages/notifications.js"></script>
    <link href="/adm/assets/plugins/toastr/toastr.min.css" rel="stylesheet"/>
    <script src="/adm/assets/plugins/toastr/toastr.min.js"></script>


    <script type="text/javascript">
        $(document).ready(function() {
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            $('#change_data').on('submit', function(){
                document.getElementById("saveChanges").disabled = true;
                //console.log(getCookie('login_token'));

                var email = $('input[name="email"]').val();
                var firstName = $('input[name="firstName"]').val();
                var lastName = $('input[name="lastName"]').val();
                var avatar = $('input[name="avatar"]').get(0).files[0];


                var formData = new FormData();
                formData.append('action', 'edit');
                formData.append('email', email);
                formData.append('firstName', firstName);
                formData.append('lastName', lastName);
                formData.append('avatar', avatar);
                if (!navigator.onLine) {
                    document.getElementById("textmodal").innerHTML = "Check your internet connection...";
                    document.getElementById("modal_").click();
                    return false;
                }
                $.ajax({
                    url: '/ajax/user',
                    type: 'post',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(data){
                        document.getElementById("saveChanges").disabled = false;
                        if (data.status == 'success') {

                            reloadUserDataOnPage(data);

                            toastr["success"]("All entered data were saved successfuly.", "Success");
                        } else if (data.status == 'warning'){

                            reloadUserDataOnPage(data);

                            document.getElementById("mySmallModalLabel").innerHTML = "Attention.";
                            document.getElementById("textmodal").innerHTML = data.warning_code;
                            document.getElementById("modal_").click();

                        } else if (data.status == 'error'){
                            toastr["error"](data.error_code, "Oops");
                        } else {
                            toastr["error"]("Some undefined error occured.", "Oops");
                        }
                    },
                    error: function(){
                        document.getElementById("textmodal").innerHTML = "Error, I can't connect with the server...";
                        document.getElementById("modal_").click();
                    }
                });
                return false;
            });




            $('#change_pass').on('submit', function(){
                //console.log(getCookie('login_token'));

                var oldPassword = $('input[name="oldPassword"]').val();
                var newPassword = $('input[name="newPassword"]').val();
                var confirmationNewPassword = $('input[name="confirmationNewPassword"]').val();


                if (newPassword.length < 6) {
                    document.getElementById("textmodal").innerHTML = "Length of password is lesser than 6 characters";
                    document.getElementById("modal_").click();
                } else if (newPassword != confirmationNewPassword) {
                    document.getElementById("textmodal").innerHTML = "Passwords are not same";
                    document.getElementById("modal_").click();
                } else {
                    $.post('/ajax/user', {
                        action: 'changePassword',
                        oldPassword: oldPassword,
                        newPassword: newPassword

                    }, function(data, status) {
                        if (status == 'success') {
                            if (data.status == 'success') {

                                document.getElementById("mySmallModalLabel").innerHTML = "Success!";
                                document.getElementById("textmodal").innerHTML = "You have successfuly changed your password, in 4 seconds you will be reauthorized and come back to this page.";
                                document.getElementById("modal_").click();

                            } else if (data.status == 'error') {
                                document.getElementById("textmodal").innerHTML = "Error, " + data.error_code;
                                document.getElementById("modal_").click();
                            } else {
                                document.getElementById("textmodal").innerHTML = "Error, undefined error occured.";
                                document.getElementById("modal_").click();
                            }
                        } else {
                            document.getElementById("textmodal").innerHTML = "Error, I can't connect with the server...";
                            document.getElementById("modal_").click();
                        }
                    });
                }

                return false;
            });




            $('#deleteAvatar').on('click', function(){

                $.post('/ajax/user', {
                    action: 'deleteAvatar'

                }, function(data, status) {
                    if (status == 'success') {
                        if (data.status == 'success') {
                            $('.reloadAvatar').attr("src", data.avatar).trigger("change");
                            document.getElementById("mySmallModalLabel").innerHTML = "Success!";
                            document.getElementById("textmodal").innerHTML = "You have successfuly deleted your avatar.";
                            document.getElementById("modal_").click();

                        } else {
                            document.getElementById("textmodal").innerHTML = "Error, undefined error occured.";
                            document.getElementById("modal_").click();
                        }
                    } else {
                        document.getElementById("textmodal").innerHTML = "Error, I can't connect with the server...";
                        document.getElementById("modal_").click();
                    }
                });

                return false;
            });


            $('#confirmDeleteAccount').on('click', function(){
                var password = $('#deleteUserPassword').val();
                $.post('/ajax/user', {
                    action: 'delete',
                    password: password

                }, function(data, status) {
                    if (status == 'success') {
                        if (data.status == 'success') {

                            $('#cancelDeleteAccount').click();
                            toastr["success"]("You have successfuly deleted your profile.", "Success!");

                            setTimeout(goTo, 2000, data.redirect);

                        } else if (data.status == 'error') {
                            toastr["error"]("Error, " + data.error_code, "Oops!");

                        } else {
                            toastr["error"]("Error, undefined error occured.", "Oops!");
                        }
                    } else {
                        toastr["error"]("Error, I can't connect with the server...", "Oops!");
                    }
                });

                return false;
            });




            function goTo(redirect) {
                window.location.href = redirect;
            }


            function reloadUserDataOnPage(data) {
                $('.reloadAvatar').attr("src", data.avatar).trigger("change");
                $('.reloadUserFirstName').html(data.firstName).trigger("change");
                $('.reloadUserLastName').html(data.lastName).trigger("change");
                $('.reloadUserFirstNameAndLastName').attr("alt", data.firstName + " " + data.lastName).trigger("change");
            }
            
        });


    </script>
</sc>

</html>